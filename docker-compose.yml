services:
  # 1) PHP 엔진: 라라벨 로직을 실행하는 핵심 유닛임
  app:
    build:
      context: .
      dockerfile: ./docker/php/Dockerfile
    # 타 프로젝트와 이름이 겹치지 않게 'tipworld-' 접두어 사용함
    container_name: tipworld-php
    restart: unless-stopped
    # 호스트(WSL) 사용자와 컨테이너 내부 권한을 1000번으로 일치시킴
    user: "1000:1000"
    volumes:
      - ./src:/var/www/html
      # Xdebug 설정을 컨테이너 내부로 주입함
      - ./docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/99-xdebug.ini
    environment:
      # IDE(PhpStorm 등)에서 인식할 서버 이름을 지정함
      PHP_IDE_CONFIG: "serverName=docker"
    extra_hosts:
      # 컨테이너 안에서 내 컴퓨터(호스트)로 접근 가능하게 통로를 열어줌
      - "host.docker.internal:host-gateway"
    networks:
      - tip-internal # DB, Redis와 소통하는 비공개 네트워크임

  # 2) 웹 서버: 사용자 요청을 받아 PHP로 전달함
  web:
    image: nginx:1.24-alpine
    container_name: tipworld-web
    restart: unless-stopped
    volumes:
      - ./src:/var/www/html
      # 내가 작성한 Nginx 설정 파일을 적용함
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app # PHP 컨테이너가 먼저 뜬 다음에 웹 서버가 시작됨
    networks:
      - proxy-nw     # 외부(Nginx Proxy Manager)와 소통하는 도로임
      - tip-internal # 내부(PHP)와 소통하는 도로임

  # 3) 데이터베이스: 데이터를 영구 저장함
  db:
    image: mariadb:10.11
    container_name: tipworld-db
    restart: always
    environment:
      # .env 파일에 정의된 변수값을 가져와서 설정함
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      # 컨테이너를 지워도 데이터는 'tip_db_data' 볼륨에 안전하게 보관됨
      - tip_db_data:/var/lib/mysql
    networks:
      - tip-internal # 보안을 위해 외부 프록시에 연결하지 않고 내부망만 사용함

  # 4) Redis: 캐시 및 세션 관리를 통해 속도를 높임
  redis:
    image: redis:7.2-alpine
    container_name: tipworld-redis
    restart: unless-stopped
    networks:
      - tip-internal

# 데이터를 영구 보관하기 위한 가상 디스크 영역임
volumes:
  tip_db_data:

# 네트워크 설계: 용도에 따라 두 가지로 분리함
networks:
  # 모든 서비스가 공용으로 쓰는 외부 도로임 (이미 생성되어 있어야 함)
  proxy-nw:
    external: true
  # tipworld 프로젝트 내부 컨테이너들끼리만 사용하는 전용 도로임
  tip-internal:
    driver: bridge